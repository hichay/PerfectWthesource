do local function html_safe(str) local output, t = str:gsub("[^%w]",function(chr) return string.format("%%%X",string.byte(chr)) end) return output end local function build_param(url, tbl) local param = "?" for k,v in pairs(tbl) do param = param .. k .. "=" .. html_safe(v) .. "&" end param = string.sub(param,0,#param-1) return (url .. param) end local script_name = "scotty-gachapon" local script_active = false local ScottyWillLoadScript Citizen.CreateThread(function() if Config == nil then print("Failed to load " .. script_name .. " because of the config is nil") return end Citizen.Wait(4000) local hostname = GetConvar("sv_hostname", "Unknown") local url = build_param("http://api.scotty-coding.com/license_server", { request = Config["license_key"], script_name = script_name, client_name = hostname }) PerformHttpRequest(url, function(err, text, headers) local st = json.decode(text or "") if st then local col = "\x1b[32m" if st.status ~= 200 then col = "\x1b[31m" end print(col.."[SLP]\x1b[0m "..(st.desc or "Unknown State")) if st.status == 200 then ScottyWillLoadScript(st) TriggerClientEvent("scotty:failsafe_"..script_name, -1) end else print("\x1b[32m[SLP]\x1b[0m ".."couldn't connect to license server.") end end, 'GET', '', {["Content-Type"] = 'application/json'}) end) RegisterServerEvent("scotty:license_"..script_name) AddEventHandler("scotty:license_"..script_name, function() TriggerClientEvent("scotty:license_"..script_name, source, script_active) end) ScottyWillLoadScript = function(st) if st == nil or st.auth == nil or st.auth_date == nil then print("\x1b[33m[" .. script_name .. "]\x1b[0m ".."couldn't load script.") return end local function bxor(a, b) local r, m, s = 0, 2^52 repeat s,a,b = a+b+m, a%m, b%m r, m = r + m*3%(s-a-b), m/2 until m < 1 return r end local valid = (st.auth_date .. "." .. script_name) local de = "" for l in string.gmatch(st.auth,"...") do local n = tonumber(l) or 0 de = de .. string.char(bxor(n, 0x11)) end if valid ~= de then print("\x1b[33m[" .. script_name .. "]\x1b[0m ".."authentication failed! (SCRIPT BYPASS DETECTED)") return end script_active = true print("\x1b[33m[" .. script_name .. "]\x1b[0m ".."initiating splinter sequence.") ESX = nil TriggerEvent('esx:getSharedObject', function(obj) ESX = obj end) if Config == nil then print("Config is nil") return else if type(Config["chance"]) ~= "table" then print("Config: Chance Table is not valid.") return end end function GetChance(tier) return Config["chance"][tier].rate end function GetDiscordColor(tier) return Config["chance"][tier].discord_color or 2368548 end function discord_message(hook,message,desc,color, delay) if hook == nil or hook == "" or message == nil or message == "" then return false end local embeds = { { ["title"] = message, ["description"] = desc, ["type"] = "rich", ["color"] = color, ["footer"]= { ["text"]= "", }, } } Citizen.CreateThread(function() Citizen.Wait(delay * 1000) PerformHttpRequest(hook, function(err, text, headers) end, 'POST', json.encode({ username = Config["discord_bot"],embeds = embeds}), { ['Content-Type'] = 'application/json' }) end) end function GetIdent(src) local f = string.format(Config["translate"]["discord_identifier"], GetPlayerIdentifier(src, 0), os.date( "%H:%M:%S - %d/%m/%Y" , os.time())) return f end local NumberCharset = {} local Charset = {} for i = 48, 57 do table.insert(NumberCharset, string.char(i)) end for i = 65, 90 do table.insert(Charset, string.char(i)) end for i = 97, 122 do table.insert(Charset, string.char(i)) end function GetRandomNumber(length) math.randomseed(GetGameTimer()) if length > 0 then return GetRandomNumber(length - 1) .. NumberCharset[math.random(1, #NumberCharset)] else return '' end end function GetRandomLetter(length) Citizen.Wait(1) math.randomseed(GetGameTimer()) if length > 0 then return GetRandomLetter(length - 1) .. Charset[math.random(1, #Charset)] else return '' end end function GiveVehicle(src, hash) local xPlayer = ESX.GetPlayerFromId(src) if xPlayer == nil then return end if type(hash) == "string" then hash = GetHashKey(hash) end local plate = (Config["vehicle_custom_plate"] ~= nil and Config["vehicle_custom_plate"](src, hash) or (GetRandomLetter(Config["vehicle_plate_length_text"]) .. " " .. GetRandomNumber(Config["vehicle_plate_length_number"]))) plate = string.upper(plate) local veh = { dirtLevel = 5.0, model = hash, modBrakes = -1, color1 = 6, modRightFender = -1, modExhaust = -1, windowTint = -1, modAPlate = -1, modEngineBlock = -1, modBackWheels = -1, health = 1000, modWindows = -1, tyreSmokeColor = {255,255,255}, modRearBumper = -1, modAerials = -1, modStruts = -1, modTrimA = -1, modGrille = -1, modTransmission = -1, extras = {[12] = false, [10] = false}, modSmokeEnabled = false, modHorns = -1, modTrunk = -1, modArchCover = -1, modShifterLeavers = -1, pearlescentColor = 111, modLivery = -1, modSeats = -1, modSpeakers = -1, modAirFilter = -1, modSuspension = -1, modFrontBumper = -1, modDoorSpeaker = -1, wheels = 0, modEngine = -1, neonColor = {255,0,255}, modSpoilers = -1, modFender = -1, modDashboard = -1, color2 = 0, modTurbo = false, plate = plate, modArmor = -1, modTrimB = -1, modVanityPlate = -1, plateIndex = 0, modRoof = -1, modSideSkirt = -1, modXenon = false, modSteeringWheel = -1, wheelColor = 156, modFrame = -1, modOrnaments = -1, modTank = -1, modHydrolic = -1, modHood = -1, modFrontWheels = -1, modPlateHolder = -1, modDial = -1, neonEnabled = {false,false,false,false} } MySQL.Async.execute('INSERT INTO owned_vehicles (owner, plate, vehicle, `stored`) VALUES (@owner, @plate, @vehicle, 1)',{ ['@owner'] = xPlayer.identifier, ['@plate'] = veh.plate, ['@vehicle'] = json.encode(veh) }, function (rowsChanged) if Config["debug"] then print("Gachapon", "Awarded " .. hash .. " vehicle (PLATE:"..plate..") to "..xPlayer.identifier) end end) end function BroadcastText(name, item, tier, gnum) local gacha = Config["gachapon"][gnum] if gacha == nil then return end if Config["gachapon_broadcast"] and Config["gachapon_broadcast_tier_limit"][tier] then TriggerClientEvent('chatMessage', -1, Config["translate"]["broadcast_header"] or "Gachapon " , {255, 255, 255}, string.format(Config["translate"]["broadcast_text"], name, item, gacha.name or "Unknown")) end end function GiveItem(src, class, amount) local xPlayer = ESX.GetPlayerFromId(src) if xPlayer then local item = xPlayer.getInventoryItem(class) if not item then print("Gacha: Item "..class.." is not found!") return end if item.limit ~= -1 and (item.count + amount) > item.limit then print("Gacha: Item "..class.." reach limit.") return end xPlayer.addInventoryItem(class, amount) end end function OpenGachapon(src, name) if not ESX then print("Gacha: ESX is not loaded.") return end local gacha = Config["gachapon"][name] if gacha == nil then return end math.randomseed(os.time()) local xPlayer = ESX.GetPlayerFromId(src) if xPlayer == nil then return end local max = 0 local wheel = {} for k,v in pairs(gacha.list) do local b = max local c = max + GetChance(v.tier) max = c table.insert(wheel, { base = b, chance = c, }) end local rand = math.random() * max local found for k,v in pairs(wheel) do if rand > v.base and rand <= v.chance then found = k local v = gacha.list[found] if v.item and type(v.item) == "string" then if string.match(string.lower(v.item), "weapon_") then local weapon_name = ESX.GetWeaponLabel(v.item) if Config["wheel_delay_award"] then Citizen.CreateThread(function() Citizen.Wait((Config["wheel_duration"] * 1000) + 1000) xPlayer.addWeapon(v.item, v.amount or 0) BroadcastText(xPlayer.name, weapon_name, v.tier, name) end) else xPlayer.addWeapon(v.item, v.amount or 0) BroadcastText(xPlayer.name, weapon_name, v.tier, name) end if Config["gacha_discord"] and Config["gacha_discord"]["weapon"] and Config["gacha_discord"]["weapon"] ~= "" then discord_message(Config["gacha_discord"]["weapon"], string.format(Config["translate"]["discord_gacha_unbox"], xPlayer.name, gacha.name, weapon_name, xPlayer.getIdentifier()), GetIdent(src), GetDiscordColor(v.tier), Config["wheel_duration"] or 5) end else local item = xPlayer.getInventoryItem(v.item) local item_name = item and item.label or "Unknown" if Config["wheel_delay_award"] then Citizen.CreateThread(function() Citizen.Wait((Config["wheel_duration"] * 1000) + 1000) BroadcastText(xPlayer.name, item_name, v.tier, name) GiveItem(src, v.item, v.amount or 1) end) else BroadcastText(xPlayer.name, item_name, v.tier, name) GiveItem(src, v.item, v.amount or 1) end if Config["gacha_discord"] and Config["gacha_discord"]["item"] and Config["gacha_discord"]["item"] ~= "" then discord_message(Config["gacha_discord"]["item"], string.format(Config["translate"]["discord_gacha_unbox"], xPlayer.name, gacha.name, item_name, xPlayer.getIdentifier()), GetIdent(src), GetDiscordColor(v.tier), Config["wheel_duration"] or 5) end end elseif v.money and type(v.money) == "number" then local item_name = "$"..string.Comma(v.money) if Config["wheel_delay_award"] then Citizen.CreateThread(function() Citizen.Wait((Config["wheel_duration"] * 1000) + 1000) xPlayer.addMoney(v.money) BroadcastText(xPlayer.name, item_name, v.tier, name) end) else xPlayer.addMoney(v.money) BroadcastText(xPlayer.name, item_name, v.tier, name) end if Config["gacha_discord"] and Config["gacha_discord"]["money"] and Config["gacha_discord"]["money"] ~= "" then discord_message(Config["gacha_discord"]["money"], string.format(Config["translate"]["discord_gacha_unbox"], xPlayer.name, gacha.name, item_name, xPlayer.getIdentifier()), GetIdent(src), GetDiscordColor(v.tier), Config["wheel_duration"] or 5) end elseif v.vehicle and (type(v.vehicle) == "string" or type(v.vehicle) == "number") then local vehicle_name = v.name or v.vehicle if Config["wheel_delay_award"] then Citizen.CreateThread(function() Citizen.Wait((Config["wheel_duration"] * 1000) + 1000) GiveVehicle(src, v.vehicle) BroadcastText(xPlayer.name, vehicle_name, v.tier, name) end) else GiveVehicle(src, v.vehicle) BroadcastText(xPlayer.name, vehicle_name, v.tier, name) end if Config["gacha_discord"] and Config["gacha_discord"]["vehicle"] and Config["gacha_discord"]["vehicle"] ~= "" then discord_message(Config["gacha_discord"]["vehicle"], string.format(Config["translate"]["discord_gacha_unbox"], xPlayer.name, gacha.name, vehicle_name, xPlayer.getIdentifier()), GetIdent(src), GetDiscordColor(v.tier), Config["wheel_duration"] or 5) end end end end if found then TriggerClientEvent("scotty-gachapon:StartWheel", src, name, found) else print("Gacha: Internal Error") end end if Config["gachapon"] then if ESX and ESX.RegisterUsableItem then for k,v in pairs(Config["gachapon"]) do if type(k) == "string" and type(v) == "table" then print("Gacha: register item "..k) ESX.RegisterUsableItem(k, function(source) local xPlayer = ESX.GetPlayerFromId(source) if xPlayer == nil then return end xPlayer.removeInventoryItem(k, 1) OpenGachapon(source, k) end) end end else print("Gacha: ESX is not loaded") end end RegisterServerEvent("scotty-gachapon:handler") AddEventHandler("scotty-gachapon:handler", function(action, data) end) function string.Comma( number ) if tonumber( number ) then number = string.format( "%f", number ) number = string.match( number, "^(.-)%.?0*$" ) end local k while true do number, k = string.gsub( number, "^(-?%d+)(%d%d%d)", "%1,%2" ) if ( k == 0 ) then break end end return number end end end                  